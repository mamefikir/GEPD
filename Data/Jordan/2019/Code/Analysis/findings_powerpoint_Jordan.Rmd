---
title: "Global Education Policy Dashboard"
author: "Education Global Practice, World Bank"
output:
  word_document:
    toc: yes
  html_document:
    fig_height: 6
    fig_width: 8
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
#include packages
library(tidyverse)
library(haven)
library(kableExtra)
library(skimr)
library(flextable)
library(ggridges)
library(scales)
library(spatstat)
library(ggradar)
library(Hmisc)
library(ggpmisc)
library(patchwork)
library(DT)
# define stle for ggplot based on BBC plotting styles
bbc_style <- function() {
  font <- "Helvetica"
  
  ggplot2::theme(
    
    #Text format:
    #This sets the font, size, type and colour of text for the chart's title
    plot.title = ggplot2::element_text(family=font,
                                       size=28,
                                       face="bold",
                                       color="#222222"),
    #This sets the font, size, type and colour of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    plot.subtitle = ggplot2::element_text(family=font,
                                          size=22,
                                          margin=ggplot2::margin(9,0,9,0)),
    plot.caption = ggplot2::element_blank(),
    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    
    #Legend format
    #This sets the position and alignment of the legend, removes a title and backround for it and sets the requirements for any text within the legend. The legend may often need some more manual tweaking when it comes to its exact position based on the plot coordinates.
    legend.position = "top",
    legend.text.align = 0,
    legend.background = ggplot2::element_blank(),
    legend.title = ggplot2::element_blank(),
    legend.key = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(family=font,
                                        size=18,
                                        color="#222222"),
    
    #Axis format
    #This sets the text font, size and colour for the axis test, as well as setting the margins and removes lines and ticks. In some cases, axis lines and axis ticks are things we would want to have in the chart - the cookbook shows examples of how to do so.
    axis.title = ggplot2::element_blank(),
    axis.text = ggplot2::element_text(family=font,
                                      size=18,
                                      color="#222222"),
    axis.text.x = ggplot2::element_text(margin=ggplot2::margin(5, b = 10)),
    axis.ticks = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    
    #Grid lines
    #This removes all minor gridlines and adds major y gridlines. In many cases you will want to change this to remove y gridlines and add x gridlines. The cookbook shows you examples for doing so
    panel.grid.minor = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
    panel.grid.major.x = ggplot2::element_blank(),
    
    #Blank background
    #This sets the panel background as blank, removing the standard grey ggplot background colour from the plot
    panel.background = ggplot2::element_blank(),
    
    #Strip background (#This sets the panel background for facet-wrapped plots to white, removing the standard grey ggplot background colour and sets the title size of the facet-wrap title to font size 22)
    strip.background = ggplot2::element_rect(fill="white"),
    strip.text = ggplot2::element_text(size  = 22,  hjust = 0)
  )
}

```




## Introduction





```{r data, include=FALSE}

#set directory to bring in data

work_dir<- "//wbgfscifs01/GEDEDU/datalib-edu/Projects/GEPD/CNT/JOR/JOR_2019_GEPD/JOR_2019_GEPD_v01_M/Data/"

#load public official data
load(paste(work_dir, "Public_Officials/public_officials_indicators_data_anon.RData", sep=""))

#load school data for comparisons
load(paste(work_dir, "School/school_indicators_data_anon.RData", sep=""))


#Create a function which will generate new binary variable using case_when, but 
#if value is misisng it will generate binary variable to be missing
#This is done a lot so will create function for it.
#e.g. school_absent=case_when(
#         m2sbq6_efft==6  ~ 1,
#         m2sbq6_efft!=6   ~ 0,
#         is.na(m2sbq6_efft) ~ as.numeric(NA))
bin_var <- function(var, val) {
  case_when(
    var==val  ~ 1,
    var!=val   ~ 0,
    is.na(var) ~ as.numeric(NA))
}

#create function to wrap text
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}

```




```{r dt, echo=FALSE, message=FALSE, warning=FALSE}
  
#create subset with just main indicators
    indicators_list<-c('student_proficient',
                       'student_attendance', 
                       'presence_rate',
                       'content_proficiency', 
                       'teach_prof',
                       'ecd_student_proficiency', 
                       'inputs', 
                       'infrastructure',
                       'operational_management', 
                       'instructional_leadership',
                       'principal_knowledge_score',
                       'principal_management', 
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                       'intrinsic_motivation', 
                       'standards_monitoring',
                       'monitoring', 
                       'management_clarity',
                       'management_attraction', 
                       'sch_selection_deployment', 
                       'sch_support', 
                       'principal_evaluation', 
                       'national_learning_goals',
                       'mandates_accountability',
                       'quality_bureaucracy',
                       'impartial_decision_making'
    )
 
main_indicator_labels2<-c('Proficiency on GEPD Assessment', 
                         'Student Attendance',
                         'Teacher Effort', 
                         "Teacher Content Knowledge", 
                         "Teacher Pedagogical Skills",
                         'Capacity for Learning', 
                         'Basic Inputs', 
                         'Basic Infrastructure', 
                         'Operational Management', 
                         'Instructional Leadership', 
                         'Principal Knowledge of School',
                         'Principal Management Skills', 
                         'Policy Lever (Teaching) - Attraction',
                         'Policy Lever (Teaching) - Selection & Deployment',
                         'Policy Lever (Teaching) - Support', 
                         'Policy Lever (Teaching) - Evaluation', 
                         'Policy Lever (Teaching) - Monitoring & Accountability', 
                         'Policy Lever (Teaching) - Intrinsic Motivation', 
                         'Policy Lever (Inputs & Infrastructure) - Standards',
                         'Policy Lever (Inputs & Infrastructure) - Monitoring',
                         "Policy Lever (School Management) - Clarity of Functions", 
                         'Policy Lever (School Management) - Attraction' ,                   
                         'Policy Lever (School Management) - Selection & Deployment'  ,      
                         'Policy Lever (School Management) - Support' ,                      
                         'Policy Lever (School Management) - Evaluation'    , 
                         'Politics & Bureaucratic Capacity - National Learning Goals' ,
                         'Politics & Bureaucratic Capacity - Mandates & Accountability'   ,  
                         'Politics & Bureaucratic Capacity - Quality of Bureaucracy'    ,    
                         'Politics & Bureaucratic Capacity - Impartial Decision-Making'    
                         
                         
) 


labels_df_2<-data.frame(indicators=as.character(indicators_list),
                      indicator_labels=as.character(main_indicator_labels2))



# School Survey
    metadata<-metadta
    

    sch_ipw<-school_dta_short_anon$ipw 
    
    #add function to produce weighted summary stats
      my_skim<-    skim_with( numeric = sfl( mean = ~ wtd.mean(.,  w=sch_ipw, na.rm=TRUE),
                                             sd = ~ sqrt(wtd.var(.,  weights=sch_ipw, na.rm=TRUE)),
                                             p25 = ~ (wtd.quantile(., probs=c(0.25),  weights=sch_ipw, na.rm=TRUE)),
                                             p50 = ~ (wtd.quantile(., probs=c(0.5), weights=sch_ipw, na.rm=TRUE)),
                                             p75 = ~ (wtd.quantile(., probs=c(0.75), weights=sch_ipw, na.rm=TRUE)),
                                             complete = ~ sum(!is.na(.))))

  
    sumstats_school <- school_dta_short_anon %>%
      select(one_of(indicators_list) ) 
    
    
    
    sumstats_school_df<-my_skim(sumstats_school) %>%
      yank("numeric") %>%
      mutate(variable=skim_variable) %>%
      select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
    
    
    #add variable label
    sumstats_school_df <- sumstats_school_df %>%
      mutate(name=variable,
             indicators=variable) %>%
      left_join(labels_df_2) %>%
      mutate(varlabel=indicator_labels) %>%
      mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
             ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
      mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
      select(varlabel, mean, ci)
    
    
    
    

        #add function to produce weighted summary stats
        my_skim<-    skim_with( numeric = sfl( mean = ~ wtd.mean(.,  w=sch_ipw, na.rm=TRUE),
                                               sd = ~ sqrt(wtd.var(.,  weights=sch_ipw, na.rm=TRUE)),
                                               p25 = ~ (wtd.quantile(., probs=c(0.25),  weights=sch_ipw, na.rm=TRUE)),
                                               p50 = ~ (wtd.quantile(., probs=c(0.5), weights=sch_ipw, na.rm=TRUE)),
                                               p75 = ~ (wtd.quantile(., probs=c(0.75), weights=sch_ipw, na.rm=TRUE)),
                                               complete = ~ sum(!is.na(.))))
      
      
      
    #Now do breakdown by Urban/Rural
    #urban
    sumstats_school_urban <- school_dta_short_anon %>%
      filter(rural==FALSE) 

    
    sch_ipw<-sumstats_school_urban$ipw 
    
    sumstats_school_urban <- sumstats_school_urban %>%
      select(one_of(indicators_list)) 
    
    
    
    sumstats_school_urban_df<-my_skim(sumstats_school_urban) %>%
      yank("numeric") %>%
      mutate(variable=skim_variable) %>%
      select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
    
    
    #add variable label
    sumstats_school_urban_df <- sumstats_school_urban_df %>%
      mutate(name=variable,
             indicators=variable) %>%
      left_join(labels_df_2) %>%
      mutate(varlabel=indicator_labels) %>%
      mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
             ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
      mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
      mutate(mean_urban=mean,
             ci_urban=ci) %>%
      select(varlabel, mean_urban, ci_urban)
    
    #rural
      sumstats_school_rural <- school_dta_short_anon  %>%
        filter(rural==TRUE) 

        
        sch_ipw<-sumstats_school_rural$ipw 
      
        sumstats_school_rural <- sumstats_school_rural %>%
        select(one_of(indicators_list)) 
      

    sumstats_school_rural_df<-my_skim(sumstats_school_rural) %>%
      yank("numeric") %>%
      mutate(variable=skim_variable) %>%
      select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
    
    
    #add variable label
    sumstats_school_rural_df <- sumstats_school_rural_df %>%
      mutate(name=variable,
             indicators=variable) %>%
      left_join(labels_df_2) %>%
      mutate(varlabel=indicator_labels) %>%
      mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
             ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
      mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
      mutate(mean_rural=mean,
             ci_rural=ci) %>%
      select(varlabel, mean_rural, ci_rural)
    
    #now bind urban/rural with the main results
    sumstats_school_df_final <- sumstats_school_df %>%
      left_join(sumstats_school_urban_df) %>%
      left_join(sumstats_school_rural_df)
    
      
    
  #Survey of Public Officials
    metadata<-public_officials_metadata
    
    #add function to produce weighted summary stats
    my_skim<-    skim_with( numeric = sfl( mean = ~ mean(.,   na.rm=TRUE),
                                           sd = ~ sqrt(var(.,   na.rm=TRUE)),
                                           p25 = ~ (quantile(., probs=c(0.25),   na.rm=TRUE)),
                                           p50 = ~ (quantile(., probs=c(0.5),  na.rm=TRUE)),
                                           p75 = ~ (quantile(., probs=c(0.75),  na.rm=TRUE)),
                                           complete = ~ sum(!is.na(.))))    
  
  
  sumstats_public_officials <- public_officials_dta_clean_anon %>%
    select(one_of(indicators_list) ) 
  
  
  
  sumstats_public_officials_df<-my_skim(sumstats_public_officials) %>%
    yank("numeric") %>%
    mutate(variable=skim_variable) %>%
    select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
  
  
  #add variable label
  sumstats_public_officials_df <- sumstats_public_officials_df %>%
    mutate(name=variable,
           indicators=variable) %>%
    left_join(labels_df_2) %>%
    mutate(varlabel=indicator_labels) %>%
    mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
           ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
    mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
    mutate(mean_urban=as.numeric(NA),
           ci_urban=as.numeric(NA),
           mean_rural=as.numeric(NA),
           ci_rural=as.numeric(NA)) %>%
    select(varlabel, mean, ci, mean_urban, ci_urban, mean_rural, ci_rural)
  
  
  sumstats_df <- sumstats_school_df_final %>%
    bind_rows(sumstats_public_officials_df) %>%
    arrange(factor(varlabel, levels=main_indicator_labels2))
  

   
   sumstats_df <- sumstats_df %>%
     select(varlabel,  mean, ci, mean_urban, ci_urban, mean_rural, ci_rural)
   
  #add in custom column sub-headers
  sketch = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th( rowspan = 2, 'Indicator'),
        th(colspan = 2, 'Overall'),
        th(colspan = 2, 'Urban'),
        th(colspan = 2, 'Rural'),
        th(rowspan = 2, str_wrap('Ratio of Rural to Urban',10))
      ),
      tr(
        lapply(rep(c('Mean', '95% Confident Interval'), 3), th)
      )
    )
  ))
  
  
  # create 19 breaks and 20 rgb color values ranging from white to red
  
  sumstats_df <- sumstats_df %>%
    mutate(ratio=(as.numeric(mean_rural))/as.numeric(mean_urban))
  
  brks <- seq(0, max(sumstats_df$ratio, na.rm=T), length.out = 19)
  clrs <- round(seq(40, 255, length.out = length(brks) + 1), 0) %>%
    {paste0("rgb(255,", ., ",", ., ")")}
  
  DT::datatable(sumstats_df, caption="Summary Statistics of Dashboard Indicators - Jordan 2019 - Urban/Rural",
                container = sketch, rownames=FALSE,
                class='cell-border stripe',
                escape = FALSE,
                extensions = c ('Buttons', 'FixedHeader'), 
                options=list(
                  dom = 'Bfrtip',
                  buttons = c('copy', 'csv', 'excel'),
                  pageLength = 60,
                  scrollX = TRUE, 
                  paging=FALSE,
                  ordering=F)) %>%
    formatRound(columns = c('mean', 'ci', 'mean_urban', 'ci_urban', 'mean_rural', 'ci_rural', 'ratio' ),
                digits=2)  %>% 
    formatStyle('ratio', backgroundColor = styleInterval(brks, clrs))
  

      
        #add function to produce weighted summary stats
        my_skim<-    skim_with( numeric = sfl( mean = ~ wtd.mean(.,  w=sch_ipw, na.rm=TRUE),
                                               sd = ~ sqrt(wtd.var(.,  weights=sch_ipw, na.rm=TRUE)),
                                               p25 = ~ (wtd.quantile(., probs=c(0.25),  weights=sch_ipw, na.rm=TRUE)),
                                               p50 = ~ (wtd.quantile(., probs=c(0.5), weights=sch_ipw, na.rm=TRUE)),
                                               p75 = ~ (wtd.quantile(., probs=c(0.75), weights=sch_ipw, na.rm=TRUE)),
                                               complete = ~ sum(!is.na(.))))

      
      #Now do breakdown by non-evening/Rural
      #non-evening
      sumstats_school_nonevening <- school_dta_short_anon %>%
        filter(foundation_period!="Evening") 
      
      
      sch_ipw<-sumstats_school_nonevening$ipw 
      
      sumstats_school_nonevening <- sumstats_school_nonevening %>%
        select(one_of(indicators_list)) 
      
      
      
      sumstats_school_nonevening_df<-my_skim(sumstats_school_nonevening) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_school_nonevening_df <- sumstats_school_nonevening_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_urban=mean,
               ci_urban=ci) %>%
        select(varlabel, mean_urban, ci_urban)
      
      #evening
      sumstats_school_evening <- school_dta_short_anon  %>%
        filter(foundation_period=="Evening") 
      
      
      sch_ipw<-sumstats_school_evening$ipw 
      
      sumstats_school_evening <- sumstats_school_evening %>%
        select(one_of(indicators_list)) 
      
      
      sumstats_school_evening_df<-my_skim(sumstats_school_evening) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_school_evening_df <- sumstats_school_evening_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_rural=mean,
               ci_rural=ci) %>%
        select(varlabel, mean_rural, ci_rural)
      
      #now bind urban/rural with the main results
      sumstats_school_df_final <- sumstats_school_df %>%
        left_join(sumstats_school_nonevening_df) %>%
        left_join(sumstats_school_evening_df)
      
      #Survey of Public Officials
      metadata<-public_officials_metadata
      
      #add function to produce weighted summary stats
      my_skim<-    skim_with( numeric = sfl( mean = ~ mean(.,   na.rm=TRUE),
                                             sd = ~ sqrt(var(.,   na.rm=TRUE)),
                                             p25 = ~ (quantile(., probs=c(0.25),   na.rm=TRUE)),
                                             p50 = ~ (quantile(., probs=c(0.5),  na.rm=TRUE)),
                                             p75 = ~ (quantile(., probs=c(0.75),  na.rm=TRUE)),
                                             complete = ~ sum(!is.na(.))))    
      
      
      sumstats_public_officials <- public_officials_dta_clean_anon %>%
        select(one_of(indicators_list) ) 
      
      
      
      sumstats_public_officials_df<-my_skim(sumstats_public_officials) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_public_officials_df <- sumstats_public_officials_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_urban=as.numeric(NA),
               ci_urban=as.numeric(NA),
               mean_rural=as.numeric(NA),
               ci_rural=as.numeric(NA)) %>%
        select(varlabel, mean, ci, mean_urban, ci_urban, mean_rural, ci_rural)
      
     
      sumstats_df <- sumstats_school_df_final %>%
        bind_rows(sumstats_public_officials_df) %>%
        arrange(factor(varlabel, levels=main_indicator_labels2))
      

      
      sumstats_df <- sumstats_df %>%
        select(varlabel,  mean, ci, mean_urban, ci_urban, mean_rural, ci_rural)
      
      #add in custom column sub-headers
      sketch = htmltools::withTags(table(
        class = 'display',
        thead(
          tr(
            th( rowspan = 2, 'Indicator'),
            th(colspan = 2, 'Overall'),
            th(colspan = 2, 'Non-Evening Schools'),
            th(colspan = 2, 'Evening Schools'),
            th(rowspan = 2, str_wrap('Ratio of Non-Evening to Evening',10))
          ),
          tr(
            lapply(rep(c('Mean', '95% Confident Interval'), 3), th)
          )
        )
      ))
      
      
      # create 19 breaks and 20 rgb color values ranging from white to red
      
      sumstats_df <- sumstats_df %>%
        mutate(ratio=(as.numeric(mean_rural))/as.numeric(mean_urban))
      
      brks <- seq(0, max(sumstats_df$ratio, na.rm=T), length.out = 19)
      clrs <- round(seq(40, 255, length.out = length(brks) + 1), 0) %>%
        {paste0("rgb(255,", ., ",", ., ")")}
      
      DT::datatable(sumstats_df, caption="Summary Statistics of Dashboard Indicators - Jordan 2019 - Evening Schools",
                    container = sketch, rownames=FALSE,
                    class='cell-border stripe',
                    escape = FALSE,
                    extensions = c ('Buttons', 'FixedHeader'), 
                    options=list(
                      dom = 'Bfrtip',
                      buttons = c('copy', 'csv', 'excel'),
                      pageLength = 60,
                      scrollX = TRUE, 
                      paging=FALSE,
                      ordering=F)) %>%
        formatRound(columns = c('mean', 'ci', 'mean_urban', 'ci_urban', 'mean_rural', 'ci_rural', 'ratio' ),
                    digits=2)  %>% 
        formatStyle('ratio', backgroundColor = styleInterval(brks, clrs))


        #add function to produce weighted summary stats
        my_skim<-    skim_with( numeric = sfl( mean = ~ wtd.mean(.,  w=sch_ipw, na.rm=TRUE),
                                               sd = ~ sqrt(wtd.var(.,  weights=sch_ipw, na.rm=TRUE)),
                                               p25 = ~ (wtd.quantile(., probs=c(0.25),  weights=sch_ipw, na.rm=TRUE)),
                                               p50 = ~ (wtd.quantile(., probs=c(0.5), weights=sch_ipw, na.rm=TRUE)),
                                               p75 = ~ (wtd.quantile(., probs=c(0.75), weights=sch_ipw, na.rm=TRUE)),
                                               complete = ~ sum(!is.na(.))))

      
      
      #Now do breakdown by territory
      #North
      sumstats_school_north <- school_dta_short_anon %>%
        filter(territory=="North") 
      
      
      sch_ipw<-sumstats_school_north$ipw 
      
      sumstats_school_north <- sumstats_school_north %>%
        select(one_of(indicators_list)) 
      
      
      
      sumstats_school_north_df<-my_skim(sumstats_school_north) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_school_north_df <- sumstats_school_north_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_urban=mean,
               ci_urban=ci) %>%
        select(varlabel, mean_urban, ci_urban)
      
      #middle
      sumstats_school_middle <- school_dta_short_anon  %>%
        filter(territory=="Middle") 
      
      
      sch_ipw<-sumstats_school_middle$ipw 
      
      sumstats_school_middle <- sumstats_school_middle %>%
        select(one_of(indicators_list)) 
      
      
      sumstats_school_middle_df<-my_skim(sumstats_school_middle) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_school_middle_df <- sumstats_school_middle_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_rural=mean,
               ci_rural=ci) %>%
        select(varlabel, mean_rural, ci_rural)
      
      #south
      sumstats_school_south <- school_dta_short_anon  %>%
        filter(territory=="South") 
      
      
      sch_ipw<-sumstats_school_south$ipw 
      
      sumstats_school_south <- sumstats_school_south %>%
        select(one_of(indicators_list)) 
      
      
      sumstats_school_south_df<-my_skim(sumstats_school_south) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_school_south_df <- sumstats_school_south_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_south=mean,
               ci_south=ci) %>%
        select(varlabel, mean_south, ci_south)
      
      
      #now bind urban/rural with the main results
      sumstats_school_df_final <- sumstats_school_df %>%
        left_join(sumstats_school_north_df) %>%
        left_join(sumstats_school_middle_df) %>%
        left_join(sumstats_school_south_df)
      
      
      
      
      #Survey of Public Officials
      metadata<-public_officials_metadata
      
      #add function to produce weighted summary stats
      my_skim<-    skim_with( numeric = sfl( mean = ~ mean(.,   na.rm=TRUE),
                                             sd = ~ sqrt(var(.,   na.rm=TRUE)),
                                             p25 = ~ (quantile(., probs=c(0.25),   na.rm=TRUE)),
                                             p50 = ~ (quantile(., probs=c(0.5),  na.rm=TRUE)),
                                             p75 = ~ (quantile(., probs=c(0.75),  na.rm=TRUE)),
                                             complete = ~ sum(!is.na(.))))    
      
      
      sumstats_public_officials <- public_officials_dta_clean_anon %>%
        select(one_of(indicators_list) ) 
      
      
      
      sumstats_public_officials_df<-my_skim(sumstats_public_officials) %>%
        yank("numeric") %>%
        mutate(variable=skim_variable) %>%
        select(variable, mean, sd, p0, p25, p50, p75, p100, complete,  hist) 
      
      
      #add variable label
      sumstats_public_officials_df <- sumstats_public_officials_df %>%
        mutate(name=variable,
               indicators=variable) %>%
        left_join(labels_df_2) %>%
        mutate(varlabel=indicator_labels) %>%
        mutate(ci_low=as.numeric(mean)-1.96*(as.numeric(sd)/sqrt(as.numeric(complete))),
               ci_high=as.numeric(mean)+1.96*(as.numeric(sd)/sqrt(as.numeric(complete)))) %>%
        mutate(ci=paste("[",round(ci_low,2),", ", round(ci_high,2),"]", sep="")) %>%
        mutate(mean_urban=as.numeric(NA),
               ci_urban=as.numeric(NA),
               mean_rural=as.numeric(NA),
               ci_rural=as.numeric(NA),
               mean_south=as.numeric(NA),
               ci_south=as.numeric(NA)) %>%
        select(varlabel, mean, ci, mean_urban, ci_urban, mean_rural, ci_rural, mean_south, ci_south)
      
      sumstats_df <- sumstats_school_df_final %>%
        bind_rows(sumstats_public_officials_df) %>%
        arrange(factor(varlabel, levels=main_indicator_labels2))

      
      sumstats_df <- sumstats_df %>%
        select(varlabel,  mean, ci, mean_urban, ci_urban, mean_rural, ci_rural, mean_south, ci_south)
      
      #add in custom column sub-headers
      sketch = htmltools::withTags(table(
        class = 'display',
        thead(
          tr(
            th( rowspan = 2, 'Indicator'),
            th(colspan = 2, 'Overall'),
            th(colspan = 2, 'North'),
            th(colspan = 2, 'Middle'),
            th(colspan = 2, 'South')
                      ),
          tr(
            lapply(rep(c('Mean', '95% Confident Interval'), 4), th)
          )
        )
      ))
      
      


      
      DT::datatable(sumstats_df, caption="Summary Statistics of Dashboard Indicators - Jordan 2019 - Regions",
                    container=sketch,rownames=FALSE,
                    class='cell-border stripe',
                    escape = FALSE,
                    extensions = c ('Buttons', 'FixedHeader'), 
                    options=list(
                      dom = 'Bfrtip',
                      buttons = c('copy', 'csv', 'excel'),
                      pageLength = 60,
                      scrollX = TRUE, 
                      paging=FALSE,
                      ordering=F)) %>%
        formatRound(columns = c('mean', 'ci', 'mean_urban', 'ci_urban', 'mean_rural', 'ci_rural', 'mean_south', 'ci_south' ),
                    digits=2) 
      
      
      
      
    
    
    
    

    
```





## Overall Learning

```{r learning, echo=FALSE}




learning_data_plot <- final_indicator_data_LERN_anon %>%
  bind_rows(final_indicator_data_LERN_F_anon, .id="Female") %>%
  bind_rows(final_indicator_data_LERN_M_anon, .id="Male") %>%
  mutate(Gender=case_when(
    Female==1 ~ "All Students",
    Female==2 ~ "Female",
    Male==2 ~ "Male",
    TRUE ~ as.character(NA)
    )) %>%
  select(-Female, -Male) %>%
  mutate(Type=if_else(rural==TRUE, "Rural", "Urban"))


learning_dataMedian <- summarise(group_by(learning_data_plot, Gender , Type), MD = round(weighted.median(student_knowledge, ipw, na.rm=T),1))

  ggplot(learning_data_plot, aes(x=Type, y=student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = learning_dataMedian, aes(x=Type, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  ggtitle("4th Grade Student Assessment Scores by Gender and Urban/Rural") +
  xlab(str_wrap("Urban/Rural Status", width=75))+
  ylab(str_wrap("Fraction Correcton on 4th Grade Assessment",35)) +
  scale_fill_discrete(name="Gender", 
                      labels=c('All Students','Girls','Boys' )) +
  theme_bw() +
    theme(legend.position = "bottom") 

```


## Urban/Rural Breakdowns for Infrastructure/Inputs

```{r urban_rural, echo=FALSE}


urban_rural <- school_dta_short_anon %>%
  mutate(Type=factor(rural, levels=c("TRUE", "FALSE"), labels = c("Rural", "Urban"))) %>%
  filter(!is.na(rural))



infr_urban_rural <- urban_rural %>%
  group_by(Type) %>%
  mutate(weight=ipw/sum(ipw)) %>%
  ungroup() %>%
  ggplot(aes(x=infrastructure))  +
    geom_density(aes(fill=Type , weight=weight), alpha=0.6) +
    theme_bw() +
    scale_fill_discrete(name="Type")+
  labs(x='Infrastructure Index',
       y='Density')+
  ggtitle("Infrastructure in Urban/Rural Areas")
  
infr_urban_rural

```


```{r urban_rural_input, echo=FALSE}


urban_rural_input <- school_dta_short_anon %>%
  mutate(Type=factor(rural, levels=c("TRUE", "FALSE"), labels = c("Rural", "Urban"))) %>%
  filter(!is.na(rural))



inpt_urban_rural <- urban_rural %>%
  group_by(Type) %>%
  mutate(weight=ipw/sum(ipw)) %>%
  ungroup() %>%
  ggplot(aes(x=inputs))  +
    geom_density(aes(fill=Type , weight=weight), alpha=0.6) +
    theme_bw() +
  labs(x='Input Index')+
  ggtitle("Input Across Urban/Rural")
  
inpt_urban_rural

```

## First Grade Assessment Score

- The following plots the school level average of the 4th grade assessment scores on the school level average 1st grade assessment score.  
- Note that the children assessed in 4th grade differ from the students assessed in 1st grade  
- The graph is meant to associate levels of student learning in 1st grade with 4th grade student learning.

```{r 1st_grade_plot, echo=FALSE}
 #############################
    # Create database with just learning outcomes for regressions
    ##############################


      df_reg<-school_dta_short_anon
      

      
      
      regplots<- ggplot(data=df_reg, aes(x=ecd_student_knowledge, y=student_knowledge, weight=ipw, color="#0081a8")) +
        geom_point() +
        geom_smooth(method='lm') +
        scale_color_manual(labels = c( "Principal Indicator "),  values= c( "#0081a8")) +
        theme_bw() +
        theme(
          text = element_text(size = 14),
          legend.position='none'
        ) +
        expand_limits(x = 0, y = 0) +
        ggtitle(str_wrap("Scatterplot of School Average 4th Grade Student Scores against 1st Grade Student Scores",60)) +
        labs(colour = "Indicator") +
        ylab(paste0("4th Grade Score")) +
        xlab(paste0("1st Grade Score")) +
        stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                     label.x.npc = "right", label.y.npc = 0.2,
                     formula = 'y~x', parse = TRUE, size = 5)
      
      
      regplots
      
      
      

    

    
    
```



```{r kg_pre, include=FALSE}
kg_df <- ecd_dta_anon %>%
  mutate(attend_kg_num = case_when(
    m6s1kg==1 ~ 1,
    m6s1kg==0 ~ 0,
    TRUE ~ as.numeric(NA)
  )) %>%
  mutate(attend_kg = case_when(
    m6s1kg==1 ~ "Attended KG",
    m6s1kg==0 ~ "Did Not Attend KG",
    TRUE ~ "No Response"
  )) %>%
  filter(attend_kg!="No Response") %>%
  mutate(Gender=case_when(
    m6s1q3==2 ~ "Female",
    m6s1q3==1 ~ "Male",
    TRUE ~ as.character(NA)
    )) 

```

- The following chart takes advantage of a question asked on whether the 1st grade students attended kindergarten.
- Although this estimate is not causal, students receiving Kindergarten score much better than children not receiving kindergarten  
- This is particularly true for boys who have much lower scores at the bottom end of the distribution when not receiving kindergarten
- In our sample, `r 100*round(wtd.mean(kg_df$attend_kg_num, kg_df$ipw, na.rm=T),3)` percent of students attended kindergarten

```{r kindergarten, echo=FALSE}


#overall
kg_dfMedian <- summarise(group_by(kg_df, Gender , attend_kg), MD = round(weighted.median(ecd_student_knowledge, ipw, na.rm=T),1))

  ggplot(kg_df, aes(x=attend_kg, y=ecd_student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = kg_dfMedian, aes(x=attend_kg, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  ggtitle("1st Grade Student Assessment Scores by Kindergarten Attendance") +
  xlab(str_wrap("Kindergarten Status", width=75))+
  ylab(str_wrap("Fraction Correcton on 1st Grade Assessment",35)) +
  theme_bw() +
    theme(legend.position = "bottom") 

#literacy
  kg_dfMedian <- summarise(group_by(kg_df, Gender , attend_kg), MD = round(weighted.median(ecd_literacy_student_knowledge, ipw, na.rm=T),1))

  p1<-ggplot(kg_df, aes(x=attend_kg, y=ecd_literacy_student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = kg_dfMedian, aes(x=attend_kg, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  xlab(str_wrap("Kindergarten Status", width=75))+
  ylab(str_wrap("Literacy",35)) +
  theme_bw() +
    theme(legend.position = "bottom") 

#math
    kg_dfMedian <- summarise(group_by(kg_df, Gender , attend_kg), MD = round(weighted.median(ecd_math_student_knowledge, ipw, na.rm=T),1))

  p2<-ggplot(kg_df, aes(x=attend_kg, y=ecd_math_student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = kg_dfMedian, aes(x=attend_kg, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  xlab(str_wrap("Kindergarten Status", width=75))+
  ylab(str_wrap("Numeracy ",35)) +
  theme_bw() +
    theme(legend.position = "bottom") 
#executive functioning
    kg_dfMedian <- summarise(group_by(kg_df, Gender , attend_kg), MD = round(weighted.median(ecd_exec_student_knowledge, ipw, na.rm=T),1))

  p3<-ggplot(kg_df, aes(x=attend_kg, y=ecd_exec_student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = kg_dfMedian, aes(x=attend_kg, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  xlab(str_wrap("Kindergarten Status", width=75))+
  ylab(str_wrap("Executive Functioning",35)) +
  theme_bw() +
    theme(legend.position = "bottom") 
#socio-emotional  
  kg_dfMedian <- summarise(group_by(kg_df, Gender , attend_kg), MD = round(weighted.median(ecd_soc_student_knowledge, ipw, na.rm=T),1))

  p4<-ggplot(kg_df, aes(x=attend_kg, y=ecd_soc_student_knowledge, fill=Gender)) + #now plot the output in a bar graph
    geom_boxplot(aes(weight=ipw), position="dodge") +
    geom_text(data = kg_dfMedian, aes(x=attend_kg, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = 1) +
  xlab(str_wrap("Kindergarten Status", width=75))+
  ylab(str_wrap("Socio-Emotional",35)) +
  theme_bw() +
    theme(legend.position = "bottom") 

  
  (p1 + p2) / (p3+p4) + 
  plot_annotation(title = str_wrap('1st Grade Student Assessment Scores Across Domains by Kindergarten Attendance',80))
  
```

## Teacher Pedagogical Skill
- One of the best predictors of 4th grade student achievement, along with the 1st grade scores, is the teacher's pedagogical score  
- The following plots the school level average of the 4th grade assessment scores on the teacher's pedagogical skill based on the Teach scale.  

```{r teach_plot, echo=FALSE}
 #############################
    # Create database with just learning outcomes for regressions
    ##############################


      df_reg<-school_dta_short_anon
      

      
      
      regplots<- ggplot(data=df_reg, aes(x=teach_score, y=student_knowledge, weight=ipw, color="#0081a8")) +
        geom_point() +
        geom_smooth(method='lm') +
        scale_color_manual(labels = c( "Principal Indicator "),  values= c( "#0081a8")) +
        theme_bw() +
        theme(
          text = element_text(size = 14),
          legend.position='none'
        ) +
        expand_limits(x = 0, y = 0) +
        ggtitle(str_wrap("Scatterplot of School Average 4th Grade Student Scores against Teacher Pedagogical Scores",60)) +
        labs(colour = "Indicator") +
        ylab(paste0("4th Grade Score")) +
        xlab(paste0("Teach Score")) +
        stat_poly_eq(aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                     label.x.npc = "right", label.y.npc = 0.2,
                     formula = 'y~x', parse = TRUE, size = 5)
      
      
      regplots
      
      
      

    

    
    
```

## Do principals know their schools?

- Adequate Textbooks:
  * Principals asked, "In the selected 4th grade classroom, how many of the pupils have the relevant textbooks?"
  * We can compare answer to average calculated in our school survey
  

```{r echo=FALSE}



textbooks <- final_indicator_data_PKNW_anon %>%
  left_join(final_indicator_data_INPT_anon) %>%
  left_join(school_dta_short_anon, by="hashed_school_code") %>%
  mutate(share_textbook=(m4scq5_inpt)/(m4scq4_inpt)) %>%
  mutate(share_textbook_guess=(m7sfq10_pknw)/(m4scq4_inpt)) %>%
  mutate(gap_textbooks=(m7sfq10_pknw-m4scq5_inpt)) %>%
  mutate(Type=factor(rural.x, levels=c("TRUE", "FALSE"), labels = c("Rural", "Urban"))) %>%
  filter(!is.na(Type))



ggplot(data=textbooks, aes(x=m4scq5_inpt, y=m7sfq10_pknw, color=Type)) +
  geom_point() +
  annotate("text", label=wrapper(paste("Principals over-estimate by ", round(mean(textbooks$gap_textbooks, na.rm=T),1)," pupils on average"),15), x = 5, y = 40) +
  geom_line(aes(x=m4scq5_inpt, y=m4scq5_inpt, color="45 Degree Line")) +
  theme_bw() +
  labs(x='Actual # of Pupils with Textbook',
       y='Difference between Actual & # Guessed by Principal') +
  ggtitle("How well Principals Know # of Students with Textbooks")



```


## Radar plot

```{r radar, eval=FALSE, include=FALSE}

#get list of de facto indicators
main_indicator_labels<-c( 
                        'Teaching - Attraction',
                         'Teaching - Selection & Deployment',
                         'Teaching - Support', 
                         'Teaching - Evaluation', 
                         'Teaching - Monitoring & Accountability', 
                         #'Teaching - Intrinsic Motivation', 
                         # 'Inputs & Infrastructure - Monitoring',
                         'School Management - Attraction' ,                   
                         'School Management - Selection & Deployment'  ,      
                         'School Management - Support' ,                      
                         'School Management - Evaluation'

    )  
    
    indicators_list<-c(
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                       # 'intrinsic_motivation', 
                       # 'school_monitoring', 
                       'school_management_attraction', 
                       'school_selection_deployment', 
                       'school_support', 
                       'principal_evaluation'

    )

    labels_df_radar<-data.frame(indicators=as.character(indicators_list),
                          indicator_labels=as.character(main_indicator_labels))
    
    school_ipw<-school_dta_short$school_ipw
    
    #get de facto data
    data_radar <- school_dta_short %>%
      select(school_code, indicators_list, school_ipw) %>%
      #mutate_at(.vars = indicators_list, scales::rescale) %>%
      summarise_at(.vars = indicators_list, wtd.mean, w=school_ipw, na.rm=TRUE) %>%
      mutate(group="De Facto") %>%
      select(group=group, everything())


    data_radar2 <- data_radar %>%
      mutate_at(.vars=indicators_list, ~as.numeric(sample_n(as_tibble(c(1:5)),1)[1,1])) %>%
      mutate(group="De Jure") %>%
      select(group=group, everything())

    

    
    #score expert data (this requires a lot of hard coding and transcribing)
    expert_dir <- "C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/Peru/2019/Expert Survey"

    expert_dta_final<-haven::read_dta(paste(expert_dir, 'expert_dta_final.dta', sep="/")) 

    expert_dta_radar <- expert_dta_final %>%
      select(colnames(data_radar))
    
       data_radar<- data_radar %>%
      bind_rows(expert_dta_radar)
       
   #create radar plot
    ggradar(data_radar,
            grid.min=1,
            grid.mid=3,
            grid.max=5,
            values.radar=c("1", "3", "5"),
            axis.label.size=3,
            axis.label.offset = 1.25,
            axis.labels= str_wrap(main_indicator_labels,15),
            plot.extent.x.sf = 1.5, 
            plot.extent.y.sf = 1.3,
            legend.text.size = 3
              ) +
      ggtitle(str_wrap('Radar Plot of De-Facto and De-Jure Policy Levers',50)) +
      theme_minimal()+
      theme(    axis.title = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
    panel.grid.major.x = ggplot2::element_blank()

    )
    
```


## De-Facto Policy

```{r defacto, eval=FALSE, include=FALSE}
#get list of de facto indicators
main_indicator_labels<-c( 
                        'Teaching - Attraction',
                         'Teaching - Selection & Deployment',
                         'Teaching - Support', 
                         'Teaching - Evaluation', 
                         'Teaching - Monitoring & Accountability', 
                         'Teaching - Intrinsic Motivation', 
                         # 'Inputs & Infrastructure - Monitoring',
                         'School Management - Attraction' ,                   
                         'School Management - Selection & Deployment'  ,      
                         'School Management - Support' ,                      
                         'School Management - Evaluation'

    )  
    
    indicators_list<-c(
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                       'intrinsic_motivation', 
                       # 'school_monitoring', 
                       'school_management_attraction', 
                       'school_selection_deployment', 
                       'school_support', 
                       'principal_evaluation'

    )
    

    labels_df_var<-data.frame(indicators=as.character(indicators_list),
                          indicator_labels=as.character(main_indicator_labels))    
    
    #get de facto data
data_defacto <- school_dta_short %>%
    mutate(Type=factor(rural, levels=c("TRUE", "FALSE"), labels = c("Rural", "Urban"))) %>%
    filter(!is.na(rural)) %>%
      select(school_code,Type, indicators_list, school_ipw) %>%
      pivot_longer(cols=indicators_list,
               names_to = "indicators",
               values_to = "indicator_values") %>%
  left_join(labels_df_var)

  ggplot(data=data_defacto, aes(x=indicator_labels, y=indicator_values, fill='#ff0000')) + #now plot the output in a bar graph
    geom_boxplot(position="dodge") +
    # scale_x_discrete(labels = str_wrap(indicator_labels, width = 25)) + 
  xlab(str_wrap("Policy Lever Indicators", width=75))+
  ylab("Scale (1-5)") +
  ggtitle(str_wrap("Boxplot of Overall Indicators for Policy Levers", width=75)) +
  scale_fill_discrete(name="Rural Status") +
  theme_bw() +
    theme(legend.position = "none") +
    coord_flip()

dataMedian <- summarise(group_by(data_defacto, indicators), MD = round(median(indicator_values, na.rm=T),1))
datafirst <- summarise(group_by(data_defacto, indicators), MD = round(quantile(indicator_values, probs=c(0.25), na.rm=TRUE),1))
datathird <- summarise(group_by(data_defacto, indicators), MD = round(quantile(indicator_values, probs=c(0.75), na.rm=TRUE),1))

datagap <- summarise(group_by(data_defacto, indicators), MD = round(quantile(indicator_values, probs=c(0.75), na.rm=TRUE)-quantile(indicator_values, probs=c(0.25), na.rm=TRUE),1))
summary(datafirst)
summary(datathird)

summary(datagap)

```


```{r radar2, eval=FALSE, include=FALSE}

#get list of de facto indicators
main_indicator_labels<-c( 
                        'Teaching - Attraction',
                         'Teaching - Selection & Deployment',
                         'Teaching - Support', 
                         'Teaching - Evaluation', 
                         'Teaching - Monitoring & Accountability', 
                         'Teaching - Intrinsic Motivation', 
                         'Inputs & Infrastructure - Standards',
                         #'Inputs & Infrastructure - Monitoring',
                         'School Management - Attraction' ,                   
                         'School Management - Selection & Deployment'  ,      
                         'School Management - Support' ,                      
                         'School Management - Evaluation',
                        'Learners - Nutrition',
                        'Learners - Heath',
                        'Learners - Center Based Care',
                        'Learners - Financial Capacity',
                        'Learners - Caregiver Skills'
                        

    )  
    
    indicators_list<-c(
                       'teacher_attraction', 
                       'teacher_selection_deployment', 
                       'teacher_support', 
                       'teaching_evaluation', 
                       'teacher_monitoring',
                        'intrinsic_motivation', 
                       'standards_monitoring',
                        #'school_monitoring', 
                       'school_management_attraction', 
                       'school_selection_deployment', 
                       'school_support', 
                       'principal_evaluation',
                       'nutrition_programs',
                       'health_programs',
                       'ece_programs',
                       'financial_capacity',
                       'caregiver_skills'

    )

    labels_df_radar<-data.frame(indicators=as.character(indicators_list),
                          indicator_labels=as.character(main_indicator_labels))
    
    school_ipw<-school_dta_short$school_ipw
    
    #get de facto data
    data_radar <- school_dta_short %>%
            mutate(nutrition_programs=4.1,
             health_programs=3.95,
             ece_programs=3.85,
             financial_capacity=2.3,
             caregiver_skills=4.415) %>% #need to automate this
      select(school_code, indicators_list, school_ipw) %>%
      #mutate_at(.vars = indicators_list, scales::rescale) %>%
      summarise_at(.vars = indicators_list, wtd.mean, w=school_ipw, na.rm=TRUE) %>%
      mutate(group="De Facto") %>%
      select(group=group, everything())



    data_radar2 <- data_radar %>%
            mutate(nutrition_programs=4.1,
             health_programs=3.95,
             ece_programs=3.85,
             financial_capacity=2.3,
             caregiver_skills=4.415) %>% #need to automate this
      mutate_at(.vars=indicators_list, ~as.numeric(sample_n(as_tibble(c(1:5)),1)[1,1])) %>%
      mutate(group="De Jure") %>%
      select(group=group, everything())

    

    
    #score expert data (this requires a lot of hard coding and transcribing)
    expert_dir <- "C:/Users/wb469649/WBG/Ezequiel Molina - Dashboard (Team Folder)/Country_Work/Peru/2019/Expert Survey"

    expert_dta_final<-haven::read_dta(paste(expert_dir, 'expert_dta_final.dta', sep="/")) 

    expert_dta_radar <- expert_dta_final %>%
      mutate(standards_monitoring=inputs_standards) %>%
      select(colnames(data_radar))
    
       data_radar<- data_radar %>%
      bind_rows(expert_dta_radar)
       
   #create radar plot
    ggradar(data_radar,
            grid.min=1,
            grid.mid=3,
            grid.max=5,
            values.radar=c("1", "3", "5"),
            axis.label.size=3,
            axis.label.offset = 1.25,
            axis.labels= str_wrap(main_indicator_labels,15),
            plot.extent.x.sf = 1.5, 
            plot.extent.y.sf = 1.3,
            legend.text.size = 3
              ) +
      ggtitle(str_wrap('Radar Plot of De-Facto and De-Jure Policy Levers',50)) +
      theme_minimal()+
      theme(    axis.title = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_blank(),
    axis.text.y = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    panel.grid.minor = ggplot2::element_blank(),
    panel.grid.major.y = ggplot2::element_line(color="#cbcbcb"),
    panel.grid.major.x = ggplot2::element_blank()

    )
    
    defacto_dejure2<-data_radar %>%
  pivot_longer(cols=colnames(data_radar)[-1],
               names_to='Policy',
               values_to = 'value') %>%
  arrange(Policy, group) %>%
  group_by(Policy) %>%
  summarise(gap=(nth(value,2)-nth(value, 1)))

mean(defacto_dejure2$gap)
var(defacto_dejure2$gap)

    
```






```{r dejure_defacto_gap, eval=FALSE, include=FALSE}
#calculate gap between de_jure and de_facto

defacto_dejure<-data_radar %>%
  pivot_longer(cols=colnames(data_radar)[-1],
               names_to='Policy',
               values_to = 'value') %>%
  arrange(Policy, group) %>%
  group_by(Policy) %>%
  summarise(gap=(nth(value,2)-nth(value, 1)))

mean(defacto_dejure$gap)
var(defacto_dejure$gap)


```



## Overall performance for Bureuacracy Indicators

```{r overall, echo=FALSE}

public_officials_dta_clean_anon <- public_officials_dta_clean_anon %>%
  mutate(govt_tier=if_else(govt_tier=="Regional office (or equivalent)", "District office (or equivalent)", as.character(govt_tier) )) %>%
    filter(!is.na(govt_tier)) 



data_plot <- public_officials_dta_clean_anon %>%
  mutate(govt_tier=str_remove(govt_tier, "or equivalent")) %>%
  mutate(govt_tier=str_remove(govt_tier, "\\)")) %>%
    mutate(govt_tier=str_remove(govt_tier, "\\(")) %>%
  group_by(govt_tier) %>%
  select(interview__id,  govt_tier, national_learning_goals, mandates_accountability, quality_bureaucracy, impartial_decision_making) %>%
  pivot_longer(cols=c("national_learning_goals", "mandates_accountability", 
                      "impartial_decision_making","quality_bureaucracy" ),
               names_to = "indicators",
               values_to = "indicator_values") 

dataMedian <- summarise(group_by(data_plot, indicators , govt_tier), MD = round(median(indicator_values, na.rm=T),1))

  ggplot(data_plot, aes(x=indicators, y=indicator_values, fill=govt_tier)) + #now plot the output in a bar graph
    geom_boxplot(position="dodge") +
    geom_text(data = dataMedian, aes(x=indicators, y=MD, label=MD), 
              position = position_dodge(width = 0.8), size = 3, vjust = -0.5) +
    scale_x_discrete(labels = str_wrap(c("Impartial Decision Making",
                                         "Mandates & Accountability",
                                         "National Learning Goals",
                                         "Quality of the Bureaucracy"), width = 25)) + 
  xlab(str_wrap("Survey of Public Officials Indicators", width=75))+
  ylab("Scale (1-5)") +
  ggtitle(str_wrap("Boxplot of Overall Indicators for Survey of Public Officials", width=75)) +
  scale_fill_discrete(name="Government Level") +
  theme_bw() +
    theme(legend.position = "bottom") 

```
